{% extends 'base.html' %}
{% block stylesheets %}
<style>
  .container {
    margin-top: 20px;
  }

  .comment-header {
    background-color: #211951; /* Darker header background */
    color: #ecf0f1; /* Light text for contrast */
    padding: 10px;
    border-top-left-radius: 6px; /* Rounded corners for the top */
    border-top-right-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between; /* Space out items */
  }

  .comment-body {
    background-color: #365486; /* Lighter than the header but still dark */
    padding: 15px;
    border-bottom-left-radius: 6px; /* Rounded corners for the bottom */
    border-bottom-right-radius: 6px;
  }

  .comment-wrapper {
    margin-bottom: 20px; /* Space between comments */
    border-radius: 6px; /* If the comment-wrapper is used */
  }
  .profile-picture {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    margin-right: 10px;
    border: 3px solid #ecf0f1; /* Border color for the profile picture */
    object-fit: cover;
  }
  .comment-details {
    flex-grow: 1;
  }
  .comment-author {
    font-size: 1.2rem; /* Larger font size for the author */
    color: #f1c40f; /* Highlight color for the author's name */
    font-weight: bold;
    margin-right: 5px;
  }
  .comment-metadata {
    font-size: 0.85rem;
    color: #bdc3c7; /* Subdued color for metadata */
  }
  .comment-body {
    font-size: 1rem;
    color: #ecf0f1; /* Light text color for main comment body */
    /* padding-left: 70px; */
  }
  .comment-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end; /* Align action buttons to the right */
    padding-top: 10px; /* Space between comment content and buttons */
  }
  .comment-action-btn {
    background: none;
    border: none;
    color: #ecf0f1; /* Same as comment text color */
    cursor: pointer;
  }
  .reply-section {
    margin-top: 10px;
    padding-left: 20px; /* Indent replies */
    border-left: 3px solid #7f8c8d; /* Vertical line for replies */
    background: #34495e; /* different background color for replies */
  }

  .reply-header {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    color: #95a5a6; /* Subtle color for reply header */
  }

  .reply-to {
    font-style: italic;
  }

  .btn-reply {
    font-size: 0.8rem;
    padding: 0.2rem 0.6rem;
    margin: 0; /* Override default margins */
    color: white;
    background-color: #211951;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-reply:hover {
    color: black;
    
  }
  /* Style for the 'Post Comment' form */
  .comment-form-wrapper {
    background-color: #34495e; 
    padding: 20px;
    border-radius: 8px;
    margin-top: 30px; /* Space from the last comment */
  }
  .comment-form-wrapper h5 {
    color: #ecf0f1; /* Light color for the form title */
    margin-bottom: 15px;
  }

  
  .comment-form-textarea {
    width: 100%;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #7f8c8d; /* Subtle border color */
    min-height: 100px; /* Larger text area for comments */
    background-color: #365486; /* Slightly lighter than form background for contrast */
    color: white; /* Light text color */
  }

  /* move the likes over to the left */
  .likes {
    color: #aea7d6 !important;
  }

  /* like button move to the left */
  .likes-btn {
    margin-right: auto;
  }

  /* move the subscribe button to the right */
  .subscribe-btn {
    margin-left: auto;
    float: right;
    background-color: #211951;

  }

  /* make sure the pre will wrap arround when it reaches the end of the line */
  pre {
    white-space: pre-wrap;
  }

  .responsive-iframe {
    position: relative;
    overflow: hidden;
    padding-top: 56.25%; /* Aspect ratio of 16:9 */
  }
  
  .responsive-iframe iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }
  

</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-12 comment-section">
      <h2 class="text-white">{{ thread.title }}
        <span> 
          {% if user.is_authenticated %}
            {% if user in thread.subscribers.all %}
              <a href="{% url 'unsubscribe_from_thread' thread.id %}" class="btn btn-danger subscribe-btn">Unsubscribe</a>
            {% else %}
              <a href="{% url 'subscribe_to_thread' thread.id %}" class="btn btn-primary subscribe-btn">Subscribe</a>
            {% endif %}
          {% endif %}
        </span>
      </h2> <!-- Title with adjusted color for visibility -->
      <!-- Subscribe button -->

      <!-- Comment Loop -->
      {% for comment in comments %}
      <div class="comment-wrapper">
        <div class="comment-header">
          <!-- Profile Picture -->
          {% if comment.user.profile.profile_picture %}
            <img src="{{ comment.user.profile.profile_picture.url }}" alt="{{ comment.user.username }}'s profile picture" class="profile-picture">
          {% else %}
          {% load static %}

            <img src="{% static 'default-profile-picture.png' %}" alt="Default profile picture" class="profile-picture">
          {% endif %}
          <!-- Comment Details -->
          <div class="comment-details">
            <span class="comment-author">{{ comment.user.username }}</span>
            <!-- Include any badges or awards here -->
            <div class="comment-metadata">
              <span>{{ comment.created_at|date:"M d, Y H:i" }}</span> <!-- Timestamp -->
              {% if comment.last_edited %}
                <span>(edited)</span> <!-- Show if edited -->
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Comment Body -->
        <div class="comment-body">
          <!-- If it's a reply to another comment, show this -->
          {% if comment.parent %}
          <div class="reply-section">
            <div class="reply-wrapper">
              <div class="reply-header">
                <span class="text-muted">{{comment.parent.user }} wrote on {{ comment.parent.created_at|date:"F j, Y, g:i a" }}</span>
              </div>
              <!-- Reply Content -->
              <div class="comment-content">
                "{{ comment.parent.content|truncatewords:20 }}"
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Print the comment, and allow for the urls to apply -->
          {% autoescape off %}
            <pre>{{ comment.content }}</pre>
          {% endautoescape %}

          <!-- If it's a reply to another comment, show this -->

        <!-- Comment Actions -->
        <div class="comment-actions">
          <!-- Making it a little compleicated to fix the styling issues, but the likes text should be aligned to the left, and if logged in there should be a button for liking-->
            {% if user.is_authenticated %}
            {% if user.is_authenticated and comment.user != user %}
              {% if user in comment.likes.all %}
              <span class="text-muted likes">Likes: {{ comment.likes.count }}</span>
              <a href="{% url 'like_comment' comment.id %}" class="comment-action-btn likes-btn">Unlike</a>
              {% else %}
              <span class="text-muted likes">Likes: {{ comment.likes.count }}</span>
              <a href="{% url 'like_comment' comment.id %}" class="comment-action-btn likes-btn">Like</a>
              {% endif %}
            {% else %}
              <span class="text-muted likes likes-btn">Likes: {{ comment.likes.count }}</span>
            {% endif %}

          {% if comment.user == user or user.is_superuser %}
            <a href="{% url 'edit_comment' comment.id %}" class="comment-action-btn">Edit</a>
            <a href="{% url 'delete_comment' comment.id %}" class="comment-action-btn">Delete</a>
          {% endif %}
          <button class="comment-action-btn btn-reply" data-commentid="{{ comment.id }}">Reply</button>

          {% endif %}
        </div>
      </div>

      </div>
      {% endfor %}
  <!-- Pagination Links -->
  <div class="text-center">
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            {% if comments.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'thread_detail' thread.id %}?page=1" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{% url 'thread_detail' thread.id %}?page={{ comments.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}
              
            {% for num in comments.paginator.page_range %}
                {% if num >= comments.number|add:'-3' and num <= comments.number|add:'3' %}
                    <li class="page-item {% if num == comments.number %}active{% endif %}">
                        <a class="page-link" href="{% url 'thread_detail' thread.id %}?page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
                  
            {% if comments.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'thread_detail' thread.id %}?page={{ comments.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="{% url 'thread_detail' thread.id %}?page={{ comments.paginator.num_pages }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
  </div>




  {% if user.is_authenticated %}
  <div class="comment-form-wrapper">
    <h5>Leave a Comment</h5>
    <form method="post" action="{% url 'create_comment' thread.id %}">
      {% csrf_token %}
      <textarea name="content" class="comment-form-textarea" placeholder="Write your comment here..."></textarea>
      <button type="submit" class="btn">Post Comment</button>
    </form>
    
  </div>
  {% else %}
  <p class="mt-4">Please <a href="{% url 'login' %}">log in</a> to post a comment.</p>
  {% endif %}

    </div>
    
    
  </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1" role="dialog" aria-labelledby="replyModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="replyModalLabel">Reply to Comment</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="post" action="" id="replyForm">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="parent" id="parentCommentId" value="">
          <div class="form-group">
            <textarea name="content" class="form-control" id="replyContent" rows="3" placeholder="Write your reply here..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Post Reply</button>
        </div>
      </form>
    </div>
    
  </div>
  
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function() {
    $('.btn-reply').click(function() {
      var parentCommentId = $(this).data('commentid');
      var replyFormAction = "{% url 'reply_to_comment' thread.id 0 %}".replace('/0/', '/' + parentCommentId + '/');
      $('#replyForm').attr('action', replyFormAction);
      $('#parentCommentId').val(parentCommentId);
      $('#replyModal').modal('show');
    });
  
    $('#replyModal').on('hidden.bs.modal', function (e) {
      $('#replyForm')[0].reset();
      $('#replyForm').attr('action', '');
      $('#parentCommentId').val('');
    });
  });
</script>
{% endblock %}

